<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>EyeMind Web Tool</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- WebGazer for eye tracking -->
  <script src="https://webgazer.cs.brown.edu/webgazer.js"></script>
  <style>
    body { padding-top: 4rem; }
    .nav-tabs { margin-bottom: 1rem; }
    .cal-point { width:30px;height:30px;border-radius:50%;background:#007bff;position:absolute;cursor:pointer; }
    #slide-content { height:200px; overflow:auto; background:#f8f9fa; padding:1rem; border:1px solid #ddd; margin-bottom:1rem;}
    table { width:100%; }
    th, td { text-align:center; }
    .hidden { display:none; }
  </style>
</head>
<body>
  <div class="container">
    <ul class="nav nav-tabs" id="tabs">
      <li class="nav-item"><a class="nav-link active" data-bs-target="#risk" data-bs-toggle="tab">1. Risk</a></li>
      <li class="nav-item"><a class="nav-link disabled" data-bs-target="#gaze" data-bs-toggle="tab">2. Gaze</a></li>
      <li class="nav-item"><a class="nav-link disabled" data-bs-target="#dce" data-bs-toggle="tab">3. DCE</a></li>
      <li class="nav-item"><a class="nav-link disabled" data-bs-target="#rec" data-bs-toggle="tab">4. Rec</a></li>
    </ul>
    <div class="tab-content">
      <!-- RISK TAB -->
      <div class="tab-pane fade show active" id="risk">
        <h4>Loneliness Risk Screener</h4>
        <form id="risk-form">
          <div class="mb-3">
            <label>1. How often do you feel left out?</label>
            <select class="form-select" id="q1">
              <option value="0">Never</option>
              <option value="1">Sometimes</option>
              <option value="2">Often</option>
            </select>
          </div>
          <div class="mb-3">
            <label>2. How often do you lack companionship?</label>
            <select class="form-select" id="q2">
              <option value="0">Never</option>
              <option value="1">Sometimes</option>
              <option value="2">Often</option>
            </select>
          </div>
          <div class="mb-3">
            <label>3. How often do you feel isolated?</label>
            <select class="form-select" id="q3">
              <option value="0">Never</option>
              <option value="1">Sometimes</option>
              <option value="2">Often</option>
            </select>
          </div>
          <button type="submit" class="btn btn-primary">Calculate Risk</button>
        </form>
        <div id="risk-result" class="mt-3"></div>
      </div>

      <!-- GAZE TAB -->
      <div class="tab-pane fade" id="gaze">
        <h4>Gaze Engagement Calibration & Reading</h4>
        <p>First, click each corner dot to calibrate.</p>
        <div id="cal-area" style="position:relative; height:250px; background:#eee;">
          <div id="cp0" class="cal-point" style="top:0;left:0;"></div>
          <div id="cp1" class="cal-point" style="top:0;right:0;"></div>
          <div id="cp2" class="cal-point" style="bottom:0;right:0;"></div>
          <div id="cp3" class="cal-point" style="bottom:0;left:0;"></div>
        </div>
        <button id="start-read" class="btn btn-success mt-3 hidden">Start Reading</button>
        <div id="slide-content" class="hidden">
          <!-- Slide deck of characteristics -->
          <div class="slide">
            <h5>Characteristic 1: Type of support program</h5>
            <ul>
              <li><strong>Peer support:</strong> Mutual help among people with shared experience.</li>
              <li><strong>Community engagement:</strong> Local activities (clubs, volunteering).</li>
              <li><strong>Counselling:</strong> Professional psychological support.</li>
              <li><strong>Virtual reality:</strong> Immersive social VR experiences.</li>
            </ul>
          </div>
          <div class="slide hidden">
            <h5>Characteristic 2: Method of interaction</h5>
            <ul>
              <li><strong>In‑person</strong></li>
              <li><strong>Virtual</strong></li>
              <li><strong>Hybrid</strong></li>
            </ul>
          </div>
          <div class="slide hidden">
            <h5>Characteristic 3: Frequency</h5>
            <ul><li>Daily</li><li>Weekly</li><li>Monthly</li></ul>
          </div>
          <div class="slide hidden">
            <h5>Characteristic 4: Duration</h5>
            <ul><li>30 minutes</li><li>2 hours</li><li>4 hours</li></ul>
          </div>
          <div class="slide hidden">
            <h5>Characteristic 5: Accessibility</h5>
            <ul><li>At home</li><li>Local area (≤12 km)</li><li>Wider community (≥50 km)</li></ul>
          </div>
          <div class="slide hidden">
            <h5>Characteristic 6: Cost</h5>
            <ul><li>Free</li><li>A$ 5/session</li><li>A$ 20/session</li><li>A$ 50/session</li></ul>
          </div>
        </div>
        <div id="slide-controls" class="mt-2 hidden">
          <button id="prev-slide" class="btn btn-secondary">Prev</button>
          <button id="next-slide" class="btn btn-secondary">Next</button>
          <button id="finish-read" class="btn btn-primary hidden">Done Reading</button>
        </div>
      </div>

      <!-- DCE TAB -->
      <div class="tab-pane fade" id="dce">
        <h4>Support Program Discrete Choice</h4>
        <p>Choose between Program A and Program B for each task:</p>
        <form id="dce-form">
          <div id="task-container"></div>
          <button type="submit" class="btn btn-primary mt-3">Submit Choices</button>
        </form>
      </div>

      <!-- RECOMMENDATIONS TAB -->
      <div class="tab-pane fade" id="rec">
        <h4>Your Personalized Recommendations</h4>
        <div id="rec-content"></div>
        <p><em>“AI” here means our algorithmic engine—using your risk score, gaze patterns, and DCE choices—to tailor the best programme for you.</em></p>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS bundle -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
  // === GLOBAL STATE ===
  let riskProb = 0, riskLevel = '';
  let gazeData = [], calibrated = [false, false, false, false];
  let slideIndex = 0;
  let dceResponses = [];
  const tasks = [
    // Task 1
    {
      A: { type:'Counselling', method:'Hybrid', freq:'Weekly', duration:'2h', access:'Wider', cost:5 },
      B: { type:'VR', method:'Virtual', freq:'Monthly', duration:'4h', access:'Home', cost:20 }
    },
    // Task 2
    {
      A: { type:'Peer support', method:'Virtual', freq:'Weekly', duration:'2h', access:'Home', cost:50 },
      B: { type:'Counselling', method:'Hybrid', freq:'Daily', duration:'30m', access:'Local', cost:20 }
    },
    // Task 3
    {
      A: { type:'Counselling', method:'Hybrid', freq:'Weekly', duration:'2h', access:'Local', cost:20 },
      B: { type:'Community', method:'In-person', freq:'Monthly', duration:'30m', access:'Wider', cost:50 }
    },
    // Task 4
    {
      A: { type:'Community', method:'In-person', freq:'Weekly', duration:'4h', access:'Home', cost:20 },
      B: { type:'VR', method:'Hybrid', freq:'Daily', duration:'30m', access:'Local', cost:20 }
    },
    // Task 5
    {
      A: { type:'Community', method:'Hybrid', freq:'Monthly', duration:'4h', access:'Wider', cost:5 },
      B: { type:'Peer support', method:'In-person', freq:'Daily', duration:'2h', access:'Home', cost:50 }
    },
    // Task 6
    {
      A: { type:'VR', method:'In-person', freq:'Monthly', duration:'4h', access:'Wider', cost:20 },
      B: { type:'Counselling', method:'In-person', freq:'Weekly', duration:'30m', access:'Local', cost:0 }
    },
    // Task 7
    {
      A: { type:'Community', method:'In-person', freq:'Daily', duration:'2h', access:'Home', cost:20 },
      B: { type:'Peer support', method:'Hybrid', freq:'Weekly', duration:'4h', access:'Wider', cost:0 }
    },
    // Task 8
    {
      A: { type:'Community', method:'In-person', freq:'Daily', duration:'30m', access:'Wider', cost:5 },
      B: { type:'VR', method:'Hybrid', freq:'Weekly', duration:'4h', access:'Home', cost:50 }
    },
    // Task 9 (dominance)
    {
      A: { type:'Community', method:'In-person', freq:'Daily', duration:'30m', access:'Home', cost:0 },
      B: { type:'Counselling', method:'Hybrid', freq:'Monthly', duration:'4h', access:'Wider', cost:50 }
    }
  ];

  // === UTILITIES ===
  function activateTab(idx){
    let tabs = document.querySelectorAll('#tabs .nav-link');
    let panes = document.querySelectorAll('.tab-pane');
    tabs[idx].classList.remove('disabled');
    new bootstrap.Tab(tabs[idx]).show();
  }

  // Simple AI risk predictor (logistic)
  function aiRiskPredict(q){
    const w=[0.3,0.5,0.7], b=-1;
    let z=b + w[0]*q[0] + w[1]*q[1] + w[2]*q[2];
    let p=1/(1+Math.exp(-z));
    return p;
  }

  // === RISK FORM ===
  document.getElementById('risk-form').onsubmit = e => {
    e.preventDefault();
    const q = [+q1.value, +q2.value, +q3.value];
    riskProb = aiRiskPredict(q);
    riskLevel = riskProb>0.7?'High':riskProb>0.4?'Moderate':'Low';
    riskResult.innerHTML = `<strong>Risk:</strong> ${riskLevel} (${(riskProb*100).toFixed(1)}%)`;
    activateTab(1);
  };

  // === GAZE CALIBRATION & READING ===
  // Initialize webgazer
  webgazer.setRegression('ridge').setTracker('clmtrackr').begin();

  document.querySelectorAll('.cal-point').forEach((pt,i)=>{
    pt.onclick = () => {
      webgazer.recordScreenPosition(pt.getBoundingClientRect().left+15, pt.getBoundingClientRect().top+15,'click');
      calibrated[i]=true;
      pt.style.background='green';
      if(calibrated.every(v=>v)){
        startRead.classList.remove('hidden');
      }
    };
  });

  startRead.onclick = () => {
    webgazer.setGazeListener((data,clock)=>{
      if(data) gazeData.push({x:data.x, y:data.y, t:clock});
    });
    document.getElementById('cal-area').classList.add('hidden');
    startRead.classList.add('hidden');
    slideIndex=0; showSlide();
  };

  function showSlide(){
    document.querySelectorAll('.slide').forEach((s,i)=>
      s.classList.toggle('hidden', i!==slideIndex)
    );
    document.getElementById('slide-content').classList.remove('hidden');
    document.getElementById('slide-controls').classList.remove('hidden');
    prevSlide.classList.toggle('hidden', slideIndex===0);
    nextSlide.classList.toggle('hidden', slideIndex===document.querySelectorAll('.slide').length-1);
    finishRead.classList.toggle('hidden', slideIndex!==document.querySelectorAll('.slide').length-1);
  }
  prevSlide.onclick = ()=>{ slideIndex--; showSlide(); };
  nextSlide.onclick = ()=>{ slideIndex++; showSlide(); };
  finishRead.onclick = ()=>{
    webgazer.pause();
    // compute simple stats
    const total=gazeData.length;
    let fix=0;
    gazeData.forEach((p,i,a)=>{
      const close=a.filter(x=>Math.hypot(x.x-p.x,x.y-p.y)<50);
      if(close.length>5) fix++;
    });
    // store gazeStats
    window.gazeStats={total,fixations:fix};
    activateTab(2);
  };

  // === DCE ===
  const container = document.getElementById('task-container');
  tasks.forEach((t,i)=>{
    const div = document.createElement('div');
    div.className='mb-4';
    div.innerHTML=`
      <h6>Task ${i+1}</h6>
      <table class="table table-sm table-bordered">
        <thead><tr><th>Feature</th><th>Program A</th><th>Program B</th></tr></thead>
        <tbody>
          <tr><td>Type</td><td>${t.A.type}</td><td>${t.B.type}</td></tr>
          <tr><td>Method</td><td>${t.A.method}</td><td>${t.B.method}</td></tr>
          <tr><td>Freq</td><td>${t.A.freq}</td><td>${t.B.freq}</td></tr>
          <tr><td>Duration</td><td>${t.A.duration}</td><td>${t.B.duration}</td></tr>
          <tr><td>Access</td><td>${t.A.access}</td><td>${t.B.access}</td></tr>
          <tr><td>Cost</td><td>${t.A.cost}</td><td>${t.B.cost}</td></tr>
        </tbody>
      </table>
      <div>
        <div class="form-check form-check-inline">
          <input class="form-check-input" type="radio" name="task${i}" value="A" required>
          <label class="form-check-label">Choose A</label>
        </div>
        <div class="form-check form-check-inline">
          <input class="form-check-input" type="radio" name="task${i}" value="B">
          <label class="form-check-label">Choose B</label>
        </div>
        <div class="form-check form-check-inline">
          <input class="form-check-input" type="radio" name="task${i}" value="N">
          <label class="form-check-label">Neither</label>
        </div>
      </div>
    `;
    container.append(div);
  });

  document.getElementById('dce-form').onsubmit = e => {
    e.preventDefault();
    dceResponses = tasks.map((t,i)=>{
      const v = document.querySelector(`input[name="task${i}"]:checked`).value;
      return v==='A'?t.A : v==='B'?t.B : null;
    });
    activateTab(3);
    showRecommendations();
  };

  // === RECOMMENDATIONS ===
  function showRecommendations(){
    // derive preferences
    const count = { type:{}, method:{}, freq:{}, duration:{}, access:{}, cost:{} };
    dceResponses.forEach(r=>{
      if(!r) return;
      Object.keys(count).forEach(k=>{
        const val = r[k];
        count[k][val] = (count[k][val]||0)+1;
      });
    });
    const pref = {};
    Object.keys(count).forEach(k=>{
      const best = Object.entries(count[k]).sort((a,b)=>b[1]-a[1])[0];
      pref[k] = best ? best[0] : 'No preference';
    });
    // build recommendation
    const rec = `
      <p><strong>Based on your results:</strong></p>
      <ul>
        <li>Risk level: ${riskLevel}</li>
        <li>Most read: ${window.gazeStats.fixations} fixation clusters over ${window.gazeStats.total} points</li>
        <li>Your top preferences: 
          Type=${pref.type}, Method=${pref.method}, Freq=${pref.freq}, 
          Duration=${pref.duration}, Access=${pref.access}, Cost=${pref.cost}
        </li>
      </ul>
      <p><strong>We recommend:</strong></p>
      <p>A <em>${pref.type}</em> programme delivered <em>${pref.method}</em>, 
      <em>${pref.freq}</em>, sessions of <em>${pref.duration}</em> at 
      <em>${pref.access}</em> cost <em>${pref.cost}</em>.</p>
    `;
    recContent.innerHTML = rec;
  }
  </script>
</body>
</html>
